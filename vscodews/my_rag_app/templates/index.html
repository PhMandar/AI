<!DOCTYPE html>
<html>
<head>
  <title>Ask the LLM</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    #spinner { display: none; }
    .answer-cell { padding: 8px; }
    .answer-date { font-size: 0.8em; color: gray; margin-top: 4px; }
    .input-row { margin-top: 20px; }
    button { margin-left: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h3>Answers</h3>
    <table id="answersTable">
      <thead>
        <tr>
          <th>Question</th>
          <th>Answer</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be appended here -->
      </tbody>
    </table>

    <div class="input-row">
      <form id="askForm">
        <input type="text" id="question" name="question" placeholder="Enter your question" required>
        <button type="submit">OK</button>
        <button type="button" id="micBtn"><i class="fa fa-microphone"></i> Speak</button>
        <button type="button" id="downloadBtn"><i class="fa fa-download"></i> Chat History</button>
      </form>
    </div>

    <div id="spinner">
      <div class="loader"></div>
      <p>Processing...</p>
    </div>
  </div>

  <script>
    // --- Form submission ---
    document.getElementById("askForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const question = document.getElementById("question").value;

      document.getElementById("spinner").style.display = "block";

      try {
        const response = await fetch("/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        const data = await response.json();

        const tableBody = document.getElementById("answersTable").querySelector("tbody");
        const newRow = document.createElement("tr");
        const timestamp = new Date().toLocaleString();

        newRow.innerHTML = `
          <td>${question}</td>
          <td class="answer-cell">
            <div>${data.answer}</div>
            <div class="answer-date">${timestamp}</div>
          </td>
        `;
        tableBody.appendChild(newRow);

        // Speak the answer aloud
        speakText(data.answer);

        document.getElementById("question").value = "";
      } catch (err) {
        alert("Error fetching answer.");
      } finally {
        document.getElementById("spinner").style.display = "none";
      }
    });

    // --- CSV Export ---
    document.getElementById("downloadBtn").addEventListener("click", function() {
      const rows = document.querySelectorAll("#answersTable tr");
      let csvContent = "";
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`).join(",");
        csvContent += rowData + "\n";
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "qa_history.csv";
      link.click();
    });

    // --- Speech Recognition setup ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;

      document.getElementById("micBtn").addEventListener("click", () => {
        recognition.start();
      });

      recognition.onresult = (event) => {
        const spokenText = event.results[0][0].transcript;
        document.getElementById("question").value = spokenText;
        document.getElementById("askForm").dispatchEvent(new Event("submit"));
      };
    } else {
      document.getElementById("micBtn").disabled = true;
      alert("Speech recognition not supported in this browser.");
    }

    // --- Speech Synthesis setup ---
    function speakText(text) {
      if ("speechSynthesis" in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-US";
        speechSynthesis.speak(utterance);
      }
    }
  </script>
</body>
</html>
